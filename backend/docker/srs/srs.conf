# BigFoot Live SRS Configuration
# Optimized for live streaming events with recording and analytics

listen              1935;
max_connections     1000;
srs_log_tank        file;
srs_log_level       info;
srs_log_file        /var/log/srs/srs.log;

# HTTP API for management and statistics
http_api {
    enabled         on;
    listen          8080;
    crossdomain     on;
    raw_api {
        enabled             on;
        allow_reload        on;
        allow_query         on;
        allow_update        on;
    }
}

# HTTP Server for HLS delivery
http_server {
    enabled         on;
    listen          8081;
    dir             /usr/local/srs/objs/nginx/html;
    crossdomain     on;
}

# WebRTC configuration for low-latency streaming
rtc_server {
    enabled on;
    listen 8000;
    # For Docker, should use external IP
    candidate $CANDIDATE;
}

# Statistics and monitoring
stats {
    network         0;
    disk            sda vda xvda xvdb;
}

# Heartbeat for monitoring
heartbeat {
    enabled      on;
    interval     9.3;
    url          http://bigfootlive-backend:3001/api/streaming/srs/heartbeat;
    device_id    "bigfootlive-srs";
    summaries    on;
}

# Main RTMP vhost for live streaming
vhost __defaultVhost__ {
    # Enable HLS delivery
    hls {
        enabled         on;
        hls_path        /usr/local/srs/objs/nginx/html/live;
        hls_fragment    2;
        hls_window      10;
        hls_on_error    ignore;
        hls_storage     disk;
        
        # HLS with multiple bitrates
        hls_dispose     30;
        hls_nb_notify   10;
        hls_wait_keyframe on;
    }
    
    # Recording configuration
    dvr {
        enabled         on;
        dvr_path        /usr/local/srs/recordings/[app]/[stream].[timestamp].flv;
        dvr_plan        session;
        dvr_duration    30;
        dvr_wait_keyframe on;
    }
    
    # Transcoding for adaptive bitrate streaming
    transcode {
        enabled     on;
        ffmpeg      /usr/local/bin/ffmpeg;
        
        engine 720p {
            enabled         on;
            vfilter {
                v               quiet;
                vf              scale=1280:720;
            }
            vcodec          libx264;
            vbitrate        2000;
            vfps            30;
            vprofile        main;
            vpreset         medium;
            vparams {
                g           60;
                keyint_min  30;
                sc_threshold 0;
            }
            acodec          aac;
            abitrate        128;
            asample_rate    44100;
            achannels       2;
            aparams {
            }
            output          rtmp://127.0.0.1:[port]/[app]?vhost=[vhost]/[stream]_720p;
        }
        
        engine 480p {
            enabled         on;
            vfilter {
                v               quiet;
                vf              scale=854:480;
            }
            vcodec          libx264;
            vbitrate        1000;
            vfps            30;
            vprofile        main;
            vpreset         medium;
            vparams {
                g           60;
                keyint_min  30;
                sc_threshold 0;
            }
            acodec          aac;
            abitrate        96;
            asample_rate    44100;
            achannels       2;
            aparams {
            }
            output          rtmp://127.0.0.1:[port]/[app]?vhost=[vhost]/[stream]_480p;
        }
    }
    
    # HTTP callbacks for stream events
    http_hooks {
        enabled         on;
        on_connect      http://bigfootlive-backend:3001/api/streaming/srs/on_connect;
        on_close        http://bigfootlive-backend:3001/api/streaming/srs/on_close;
        on_publish      http://bigfootlive-backend:3001/api/streaming/srs/on_publish;
        on_unpublish    http://bigfootlive-backend:3001/api/streaming/srs/on_unpublish;
        on_play         http://bigfootlive-backend:3001/api/streaming/srs/on_play;
        on_stop         http://bigfootlive-backend:3001/api/streaming/srs/on_stop;
        on_dvr          http://bigfootlive-backend:3001/api/streaming/srs/on_dvr;
    }
    
    # Security and authentication
    refer {
        enabled         on;
        all             off;
        publish         bigfootlive.com *.bigfootlive.com localhost;
        play            bigfootlive.com *.bigfootlive.com localhost;
    }
    
    # Bandwidth control
    bandcheck {
        enabled         on;
        key             "bigfootlive2024";
        interval        30;
        limit_kbps      4000;
    }
    
    # WebRTC configuration for this vhost
    rtc {
        enabled     on;
        bframe      discard;
    }
    
    # Forward streams to CDN (optional)
    forward {
        enabled off;
        # destination rtmp://cdn.example.com/live;
    }
}

# Special vhost for testing and development
vhost dev.bigfootlive.com {
    refer {
        enabled         on;
        all             off;
        publish         localhost 127.0.0.1 dev.bigfootlive.com;
        play            localhost 127.0.0.1 dev.bigfootlive.com;
    }
    
    hls {
        enabled         on;
        hls_path        /usr/local/srs/objs/nginx/html/live;
        hls_fragment    2;
        hls_window      10;
    }
    
    dvr {
        enabled         on;
        dvr_path        /usr/local/srs/recordings/[app]/[stream].[timestamp].flv;
        dvr_plan        session;
    }
}
